# 苹果高级字体字体表

本章讨论了许多Apple Advanced Typography（AAT）表使用的三个表组件，并总结了所有AAT表。 此外，还总结了本文档中包含的每个AAT字体表的作用。

## 表组件

本节中描述的三个表组件是二进制搜索表，查找表和状态表。 二进制搜索表包含有助于在其所在表中进行信息的二进制搜索的数据。查找表将字形索引映射到没有上下文的信息。 状态表将字形索引映射到具有上下文的动作。

## 二进制搜索表

因此，文本处理将花费尽可能少的时间，许多字体表包含的信息可加快搜索与特定字形索引关联的条目的过程。 此信息包含在二进制搜索标头或BinSrchHeader结构中。 BinSrchHeader结构的格式如下：

|类型|名称|描述|
|-|-|-|
uint16|unitSize|此搜索的查找单元的大小（以字节为单位）。
uint16|nUnits|要搜索的先前尺寸的单位数。
uint16|searchRange|unitSize的值乘以小于或等于nUnits的值的2的最大幂。
uint16|entrySelector|对数以2为底的最大幂2小于或等于nUnits的值。
uint16|rangeShift|unitSize的值乘以nUnits的差值减去2的最大乘方小于或等于nUnits的值。

为了保证二进制搜索终止，您必须在要搜索的数据末尾包含一个或多个特殊的“搜索表末尾”值。 需要包含的终止值的数量是特定于表的。 指示二进制搜索终止的值为0xFFFF。 这个特殊值的存在使搜索逻辑尽可能快，并且在字体表中的额外空间中花费的开销相当小。 二进制搜索头通常在查找表中使用。

请注意，searchRange，entrySelector和rangeShift字段是多余的。 二进制搜索表旨在与1980年代后期可用的处理器有效地协同工作； 这三个字段的包含允许在此类处理器上使用非常有效的查找算法。 现代处理器不需要这种优化，并且不再使用这三个字段。

## 查找表

查找表提供了一种查找有关字形索引的信息的方法。

一些查找表执行简单的数组类型查找。 其他涉及分组，允许您以相同的方式处理许多不同的字形索引（即查找有关它们的相同信息）。 查找表的顶级描述包含格式编号和特定于格式的标头。 查找表头的格式如下：

|类型|名称|描述|
|-|-|-|
uint16|format|该查询表的格式。 有五种查找表格式，每种格式都有一个格式编号。
variable|fsHeader|特定于格式的标头（以下各节中描述了每个标头），然后是实际的查找数据。 fsHeader结构的详细信息以不同的格式给出。

在以下描述中将查找的结果称为查找值。 对于不同类型的表，查找值的解释不同。 处理特定表的每个页面均提供有关如何解释特定于该表的查找值的信息。

查找表有五种格式：

|格式|描述|
|-|-|
0|简单数组格式。 查找数据是由字形索引索引的查找值数组。
2|段单一格式。 每个不重叠的段都有一个单独的查找值，该值适用于该段中的所有字形。 段定义为字形索引的连续范围。
4|段数组格式。 执行段映射（与格式2一样），但不是对段中所有字形的单个查找值，而是段中的每个字形都有自己的单独查找值。
6|单表格式。 查找数据是<glyph index，lookup value>对的排序列表。
8|整理后的数组格式。 查找数据是由字形索引索引的简单修剪数组。
10|扩展的修剪数组格式。 查找数据是由字形索引索引的简单修剪数组。

### 简单数组格式0查找表

格式为0的查找表的fsHeader字段提供了一个查找值数组，该查找值由字形索引索引。 这些值表示的内容取决于您要使用的查找表的字体表。

### 段单一格式2查找表

格式2查找表的fsHeader字段将字形索引的某些部分划分为连续的范围或段。 段单一格式2查找表的格式如下：

|类型|名称|描述|
|-|-|-|
|BinSrchHeader|binSrchHeader|此二进制搜索的单位为LookupSegment类型，并且始终具有最小长度6。
|LookupSegment|segments[]|实际的段（segments）。 必须已经根据每个单词中的第一个单词（每个段中的最后一个字形）对它们进行了排序。

格式2 LookupSegment的格式如下：

|类型|名称|描述|
|-|-|-|
|uint16|lastGlyph|该段中的最后一个字形索引
|uint16|firstGlyph|该段中的第一个字形索引
|variable|value|查找值（仅一个）

对于格式2查找表，单个查找值将均匀地应用于段中的所有字形。

### 段数组格式4查找表

格式4查找表的fsHeader字段将字形索引的某些部分划分为连续的范围或段。 段数组格式4查找表的格式如下：

|类型|名称|描述|
|-|-|-|
|BinSrchHeader|binSrchHeader|此二进制搜索的单位为LookupSegment类型，并且始终具有最小长度6。
|LookupSegment|segments[]|实际的段（segments）。 必须已经根据每个单词中的第一个单词（每个段中的最后一个字形）对它们进行了排序。

格式4 lookupSegment的格式如下：

|类型|名称|描述|
|-|-|-|
|uint16|lastGlyph|该段中的最后一个字形索引
|uint16|firstGlyph|该段中的第一个字形索引
|uint16|value|从表开始到数据的16位偏移(A 16-bit offset from the start of the table to the data)

单表格式6查找表
格式6查找表的fsHeader字段将查找数据存储为字形索引及其查找结果对的排序列表。 单个表Format 6查找表的格式如下：

|类型|名称|描述|
|-|-|-|
|BinSrchHeader|binSrchHeader|此二进制搜索的单位为LookupSegment类型，并且始终具有最小长度4。
|LookupSingle|entries[]|实际条目，按字形索引排序。

格式6 LookupSingle的格式如下：

|类型|名称|描述|
|-|-|-|
|uint16|glyph|字形索引
|variable|value|查询值

## 剪裁(Trimmed Array)数组格式8查找表

格式8查找表的fsHeader字段将查找数据存储为由字形索引索引的简单剪裁数组(Trimmed Array)。 它与[扩展见剪裁数组(Trimmed Array)格式10查找表](https://developer.apple.com/fonts/TrueType-Reference-Manual/RM06/Chap6Tables.html#LookupFormat10)的不同之处在于，查找值的大小必须为两个字节。

修剪后的数组格式8查找表的格式如下：

|类型|名称|描述|
|-|-|-|
|uint16|firstGlyph|剪裁数组中包含的第一个字形索引。|
|uint16|glyphCount|字形总数（等于最后一个字形减去firstGlyph的值加1）。|
|variable|valueArray[]|查找值（由字形索引索引减去firstGlyph的值）。 值数组中的条目必须为两个字节。|

## 扩展剪裁数组格式10查找表

格式10查找表的fsHeader字段将查找数据存储为由字形索引索引的简单剪裁数组。 它与剪裁数组格式8查找表的不同之处在于，它允许查找值大小，而不是两个字节。

扩展的剪裁数组格式10查找表的格式如下：

|类型|名称|描述|
|-|-|-|
|uint16|unitSize|此查找表的查找单元的大小（以字节为单位）。 允许的值为1、2、4和8。
|uint16|firstGlyph|剪裁数组中包含的第一个字形索引。
|uint16|glyphCount|字形总数（等于最后一个字形减去firstGlyph的值加1）。
|variable|valueArray[]|查找值（由字形索引索引减去firstGlyph的值）。