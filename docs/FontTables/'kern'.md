# 'kern' 表

## 一般表信息

'kern' 表包含调整字体中字形字符间距的值。 它可以有多个不同格式的子表，这些子表可以包含垂直或水平文本的信息。 字距调整值用于调整字符间距。

字距调整可以平行于文本流或垂直于文本流，或两者兼而有之。 例如，如果指定了垂直字距调整并且文本通常水平书写，则字距调整将向上或向下。

当前定义了四种字距调整格式，格式 0 到 3。文件格式规范允许定义其他格式以供进一步使用。 格式 4 及以上保留供将来使用。

每个子表可以是下面指定的四种格式之一，并且可以包含垂直或水平文本的信息。 一个字体可以有多个 'kern' 子表，但由于这些表所做的调整是附加的，包含字距调整值的子表的顺序并不重要。

字距调整表有一个标题，其中包含格式编号、存在的子表数量以及子表本身。 表头格式如表 25 所示。

## 重要的提示！

'kern' 表的先前版本将标题中的 version 和 nTables 字段定义为 UInt16 值而不是 UInt32 值。 不鼓励在 OS X 上使用旧格式（尽管 AAT 可以感知旧的字距调整表并仍然正确使用它）。 Microsoft Windows 仍然使用旧格式的 'kern' 表并且不会识别新格式。 仅针对 OS X 的字体应使用新格式； 针对 OS X 和 Windows 的字体应使用旧格式。

**表 25**：'kern' 头部

|类型|名称|描述|
|-|-|-|
|fixed32|version|字距调整表的版本号（当前版本为 0x00010000）。|
|uint32|nTables|字距调整表中包含的子表数。|

字距调整子表还有一个标题，用于标识子表的格式及其包含的信息类型。 子表标题记录在表 26 中。

**表 26**：'kern' 子表标题
|类型|名称|描述|
|-|-|-|
|uint32|length|此子表的长度（以字节为单位），包括此标头。
|uint16|coverage|使用此表的情况。 请参阅下面的说明。
|uint16|tupleIndex|元组索引（用于变体字体）。 此值指定此子表涵盖的元组。

子表覆盖字段分为以下给出的子字段。 大小以位为单位。

**表 27**：coverage
|掩码值|名称|描述|
|-|-|-|
0x8000|kernVertical|设置表是否具有垂直字距调整值
0x4000|kernCrossStream|设置表是否具有跨流(cross-stream)字距调整值
0x2000|kernVariation|设置表是否具有变化字距调整值。
0x1F00|kernUnusedBits|设置为 0。
0x00FF|kernFormatMask|设置此子表的格式（当前定义为 0-3）。

掩码值 0x4000 表示将调用跨流字距调整。 如果文本通常水平书写，则字距调整将是垂直的。 如果字距调整值为正，则文本将被调整。 如果它们是负数，文本将被缩小。 如果文本通常垂直书写，则字距调整将是水平的。 如果字距调整值为正，则文本将向右调整字距。 如果它们是负数，文本将向左调整字距。

## 字距调整子表格式
特定格式的字距调整子表跟在字距调整子表标题之后。 以下部分提供了字距调整表格式 0、1、2 和 3 的详细信息。格式 4 到 255 保留供将来使用。 当前定义了以下字距调整格式：

* 格式 0 是字距对的有序列表
* 格式 1 是用于最多八个字形的上下文字距调整的状态表
* 格式 2 是一个简单的二维字距调整值数组和一个类子表
* 格式 3 是格式 2 的紧凑形式

## 格式 0 字距子表（字距对的有序列表）

格式 0 字距调整子表将字距调整信息存储为字距调整对和值的排序列表。使用存储在字距调整子表标题中的信息，您可以对这些列表执行有效的二进制搜索。

如果搜索范围是 2 的幂，则二进制搜索的编码效率最高，因此可以通过移位而不是除法将搜索范围减少一半。通常，字距调整对的数量 nPairs 不会是 2 的幂。值 searchRange 应该是小于或等于 nPairs 的 2 的最大幂。 searchRange 未涵盖的对数（即 nPairs - searchRange）是值 rangeShift。

在进行二进制搜索循环之前，您需要确定所需的字距调整对是否在列表的 searchRange 部分中。如果是，则二进制搜索从字距调整对列表的开头开始。如果不是，则搜索从列表的开头rangeShift 字节 开始 。这将是一个入口边界。通过字距调整对列表进行的迭代次数由 entrySelector 的值决定，该值计算为小于或等于 nPairs 值的 2 的最大幂的以 2 为底的对数。

尽管这种有序列表格式紧凑且易于生成，但二进制搜索循环需要 entrySelector 迭代才能搜索。

下表给出了格式 0 字距调整子表的格式：

**表 28：**'kern' 格式 0

|类型|名称|描述|
|-|-|-|
|uint16|nPairs|	该款项中的Kerning对数。|
|uint16|searchRange|两个小于或等于Npair的值的最大能量，乘以微妙的条目字节的大小。|
|uint16|entrySelector|这被计算为两个小于或等于npairs值的最大功率的log2。此值表示必须进行搜索循环的迭代数量。例如，在八个项目的列表中，循环会有三个迭代。|
|uint16|rangeShift|Npair的值减去了两个小于或等于NPAIRS的最大能量。这乘以表格中条目的字节大小。|

kerning对和值列表遵循前面表中的最后一个字段。格式0 kerning对和值的格式如下：

**表29：** 'Kern'格式0 Kerning对和值

|类型|名称|描述|
|-|-|-|
|uint16|left|Kerning对中左撇子字形的字形索引。|
|uint16|right|Kerning对中右翼字形的字形索引。|
|sint16|value|左和右对的乐趣中的Kerning价值。如果此值大于零，则字形将分开。如果此值小于零，则将字形移动在一起。|

Kerning对的左侧（高阶单词）和右（低阶单词）的一半是无签名的32位编号，然后用数值来订购Kerning。

该表需要以0xffff的左侧字形的条目，0xffff的右侧字形和0的kerning值为0。

#### 格式1 Kerning款项（用于上下文kerning的状态表）
格式1 kerning表包含一个格式特定的标头和一个状态表，可一次允许多达八个字形。格式1 kerning表的格式特定标头如下：

|类型|名称|描述|
|-|-|-|
|StateHeader|stHeader|上下文字距调整状态表头。|
|uint16|valueTable|从子表开头到字距调整表开头的偏移量（以字节为单位）。|

上下文kerning subtable中的操作包含一个特定表的标志字段。旗帜及其描述如下：

|掩码值|解读|
|-|-|
|0x8000|压入：如果设置，请在kerning堆栈上压入此字形。
|0x4000|如果设置，请不要在进入新状态之前先进入下一个字形。
|0x3fff|值offset：字节偏移从kerning堆栈上字形的字形开始到值表的开始。

如果设置了压入标志，则将当前字形在字形阵列中的位置将其压入最多八个字形的堆栈，称为Thekerning堆栈。如果值offset为非零，则指向值表。值表是有趣的kerning值列表。每个都从Kerning堆栈中弹出一个字形，并将Kerning值应用于它。列表的末尾以奇数值的标记，其确切的解释是由串件标头中的覆盖范围确定的。

由于状态表标头中的符合性offsets（严格来说）是多余的，因此某些“ kern”表使用它来记录不应是startoftext的初始状态。要确定是否完成此操作，请计算应有的索引。如果它与实际的符合性offset不同，请将其用作初始状态。

Format 2 Kerning Table (Simple n x m Array of Kerning Values)